<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Inventario - Mascotas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f5f5f5;
      padding: 20px;
    }
    .card {
      margin-bottom: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">üêæ Sistema eCommerce - Productos Mascotas</h1>

    <!-- Login -->
    <div class="card">
      <div class="card-header">Login</div>
      <div class="card-body">
        <form id="loginForm">
          <div class="mb-3">
            <label for="email" class="form-label">Correo</label>
            <input type="email" id="email" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Contrase√±a</label>
            <input type="password" id="password" class="form-control" required />
          </div>
          <button type="submit" class="btn btn-primary">Ingresar</button>
        </form>
        <p id="loginMsg" class="mt-2 text-danger"></p>
      </div>
    </div>

    <!-- Productos -->
    <div class="card">
      <div class="card-header">Productos</div>
      <div class="card-body">
        <button id="loadProducts" class="btn btn-success mb-3">Ver productos</button>
        <ul id="productList" class="list-group"></ul>
      </div>
    </div>

    <!-- Registrar producto -->
    <div class="card" id="productCard">
      <div class="card-header">Registrar Producto</div>
      <div class="card-body">
        <form id="productForm">
          <div class="mb-3">
            <label for="nombre" class="form-label">Nombre</label>
            <input type="text" id="nombre" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="descripcion" class="form-label">Descripci√≥n</label>
            <input type="text" id="descripcion" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="precio" class="form-label">Precio</label>
            <input type="number" id="precio" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="stock" class="form-label">Stock Inicial</label>
            <input type="number" id="stock" class="form-control" required />
          </div>
          <button type="submit" class="btn btn-primary">Registrar</button>
        </form>
        <p id="productMsg" class="mt-2"></p>
      </div>
    </div>

    <!-- Inventario -->
    <div class="card" id="inventoryCard">
      <div class="card-header">Actualizar Inventario</div>
      <div class="card-body">
        <form id="inventoryForm">
          <div class="mb-3">
            <label for="productId" class="form-label">Seleccionar Producto</label>
            <select id="productId" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label for="tipo" class="form-label">Tipo de novedad</label>
            <select id="tipo" class="form-select" required>
              <option value="entrada">Entrada</option>
              <option value="salida">Salida</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="cantidad" class="form-label">Cantidad</label>
            <input type="number" id="cantidad" class="form-control" required />
          </div>
          <button type="submit" class="btn btn-warning">Actualizar Inventario</button>
        </form>
        <p id="inventoryMsg" class="mt-2"></p>
      </div>
    </div>
  </div>

  <script>
    let token = null;

    // Login
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        const res = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        if (data.token) {
          token = data.token; 
          document.getElementById("loginMsg").textContent = "‚úÖ Login exitoso";
        } else {
          document.getElementById("loginMsg").textContent = "‚ùå Credenciales inv√°lidas";
        }
      } catch (err) {
        document.getElementById("loginMsg").textContent = "‚ö†Ô∏è Error en el servidor";
      }
    });

    // Ver productos (acceso p√∫blico)
    document.getElementById("loadProducts").addEventListener("click", async () => {
      try {
        const res = await fetch("/api/productos");
        const data = await res.json();
        const list = document.getElementById("productList");
        const select = document.getElementById("productId");

        list.innerHTML = "";
        select.innerHTML = "";

        data.data.forEach((p) => {
          const li = document.createElement("li");
          li.classList.add("list-group-item");
          li.textContent = `üÜî ${p._id} | ${p.nombre} - Stock: ${p.stock}`;
          list.appendChild(li);

          const option = document.createElement("option");
          option.value = p._id;
          option.textContent = `${p.nombre} (Stock: ${p.stock})`;
          select.appendChild(option);
        });
      } catch (err) {
        alert("Error al cargar productos");
      }
    });

    // Registrar producto (requiere login)
    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!token) {
        document.getElementById("productMsg").textContent = "‚ö†Ô∏è Debes iniciar sesi√≥n para registrar productos.";
        return;
      }

      const nombre = document.getElementById("nombre").value;
      const descripcion = document.getElementById("descripcion").value;
      const precio = document.getElementById("precio").value;
      const stock = document.getElementById("stock").value;

      try {
        const res = await fetch("/api/productos", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ nombre, descripcion, precio, stock })
        });
        const data = await res.json();
        if (res.ok) {
          document.getElementById("productMsg").textContent = `‚úÖ Producto registrado con ID: ${data.data._id}`;
          document.getElementById("productForm").reset();
        } else {
          document.getElementById("productMsg").textContent = "‚ùå Error: " + (data.error || data.mensaje);
        }
      } catch (err) {
        document.getElementById("productMsg").textContent = "‚ö†Ô∏è Error en el servidor";
      }
    });

    // Actualizar inventario (requiere login)
    document.getElementById("inventoryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!token) {
        document.getElementById("inventoryMsg").textContent = "‚ö†Ô∏è Debes iniciar sesi√≥n para actualizar inventario.";
        return;
      }

      const productId = document.getElementById("productId").value;
      const tipo = document.getElementById("tipo").value;
      const cantidad = Number(document.getElementById("cantidad").value);

      try {
        const res = await fetch(`/api/productos/${productId}/inventario`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ tipo, cantidad })
        });
        const data = await res.json();
        document.getElementById("inventoryMsg").textContent = data.state
          ? "‚úÖ Inventario actualizado"
          : "‚ùå " + data.error;
      } catch (err) {
        document.getElementById("inventoryMsg").textContent = "‚ö†Ô∏è Error en servidor";
      }
    });
  </script>
</body>
</html>
